cache:
  paths:
    - .m2/repository

variables:
  MAVEN_OPTS: -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true
  MAVEN_CLI_OPTS: --batch-mode --errors -DinstallAtEnd=true -DdeployAtEnd=true

build-centos8:
  image: valtri/build-centos:8-jni
  before_script: &deps-dnf
    - dnf install -y file krb5-devel rpm-build
  script: &script-rpm
    - >
      mvn $MAVEN_CLI_OPTS verify -s $CI_SETTINGS;
      (cd target/jni; cpack -G RPM);
  artifacts: &artifacts-rpm
    paths:
      - pom.xml
      - target/*.jar
      - target/maven-archiver/*.properties
      - target/jni/kerberos-connector*.*.rpm
      - target/jni/kerberos-connector*.tar.*
      - target/jni/libkerberos-connector.so

build-debian9:
  image: valtri/build-debian:stretch-jni
  before_script: &deps-apt
    - apt-get update -qq && apt-get install -y --no-install-recommends file libkrb5-dev
  script: &script-deb
    - >
      mvn $MAVEN_CLI_OPTS verify -s $CI_SETTINGS;
      (cd target/jni; cpack -G DEB);
  artifacts: &artifacts-deb
    paths:
      - pom.xml
      - target/*.jar
      - target/maven-archiver/*.properties
      - target/jni/kerberos-connector*.*.deb
      - target/jni/kerberos-connector*.tar.*
      - target/jni/libkerberos-connector.so

build-debian10:
  image: valtri/build-debian:buster-jni
  before_script: *deps-apt
  variables:
    # workaround for https://issues.apache.org/jira/browse/MJAVADOC-595
    JAVA_HOME: /usr/lib/jvm/default-java
  script:
    - >
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" -o -n "$CI_COMMIT_TAG" ]; then
        mvn $MAVEN_CLI_OPTS deploy -s $CI_SETTINGS;
      else
        mvn $MAVEN_CLI_OPTS verify -s $CI_SETTINGS;
      fi;
      (cd target/jni; cpack -G DEB);
  artifacts: *artifacts-deb
